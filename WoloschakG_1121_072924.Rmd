---
output: 
  pdf_document:
    latex_engine: xelatex
    keep_tex: FALSE
    number_sections: TRUE
    includes: 
      in_header: header.tex # remember to include this file when copy the template
geometry: margin=2cm
fontsize: 11pt
mainfont: Calibri Light
graphics: yes
---


```{r setup, include=FALSE}
# Load required libraries
library(car)
library(onewaytests)
library(multcomp)
library(cluster)
library(stats)
library("knitr")
library("readxl")
library("lubridate")
library("broom")
library("forcats")
library("stringr")
library("tidyverse")
library("dplyr")
library("tibble")
library("kableExtra")
library("png")
library("tidyr")
library("ggpubr")
library("gtsummary")
# library(car)
library(gtools)
library(ggeasy)
library(scales)
library(dbscan)
library("lme4")
library(finalfit)
library(pheatmap)
library(umap)
library(broom.mixed)
library(ggplot2)
library(dgof)
library(cowplot)
library(kSamples)
library(labelled)

# knitr options
opts_chunk$set(echo = FALSE, 
              message = FALSE,
              include=TRUE,
               comment = "  ", prompt = TRUE) 

# format numbers
opts_knit$set(root.dir = "./") # Change working directory here
knit_hooks$set(
  inline = function(x){
    if(!is.numeric(x)){x} 
    else{prettyNum(x, big.mark = ",")}
  }
)

# formatting options
options(round = 4,
        digits = 3,
        stringsAsFactors = FALSE)
```

```{r logo,fig.align = 'center', out.width = '50%', include=TRUE}
# include FSM logo
include_graphics("FeinbergLogo.png")
```


<!-- Fill in the Names, project number and title -->
\begin{tabular}{@{}ll}
  Date: & `r format(Sys.Date(), "%B %d, %Y")`\\
  To: & Tatjana Paunesku, PhD\\
  From: & Zequn Sun, PhD and Katrina Dobinda, Biostatistics\\
  Subject: & QDSC Project 1121 - Elementalomic research (NORMALIZED VERSION)
\end{tabular}
\noindent\rule{\textwidth}{1pt}


<!-- Add table of contents -->
\tableofcontents


\newpage

<!-- # Study Description -->
<!-- ## Study background and design -->
<!-- ## Specific Aims or research questions -->
<!-- ## Statistical considerations (endpoints, analysis plan, etc) -->

```{r reading in data, warning=FALSE}
# read in the data
fpath <- "R:/PrevMed/Projects/QDSC/Projects/WoloschakG_1121/Analysis/Data/Attempt_2"

# Image Path 
image_path <-  "R:/PrevMed/Projects/QDSC/Projects/WoloschakG_1121/Analysis/Output/"
date <-  gsub("/", "", format(as.Date(Sys.Date()), "%m/%d/%y"))

# Data List
mice_file_list <- list.files(path = file.path(fpath, "CSV All Mice"), full.names=TRUE)

scan_file_list <- list.files(path = file.path(fpath, "Same cells different step scans"), pattern = "katrina", full.names=TRUE)

regions_file_list <- append(
  list.files(path = file.path(fpath, "For Katrina and Sun", "Crypts"), full.names=TRUE),
  list.files(path = file.path(fpath, "For Katrina and Sun", "InterspersedRegions"), full.names=TRUE))

# Define a function to clean and load data
clean_and_load <- function(file_path) {
  data <- read.csv(file_path, stringsAsFactors = FALSE)
  colnames(data)<- c("id","P","S","Ca","Fe","Cu","Zn")
  # Remove rows where all element columns are zero
  data <- data[!(data$P == 0 & data$S == 0 & data$Ca == 0 & data$Fe == 0 & data$Cu == 0 & data$Zn == 0),]
  data <- data[!is.na(data$`id`),]
  data <- data %>%
          dplyr::select(id:Zn) %>%
          mutate(across(P:Zn, as.numeric))
  return(data)
}

# clean_and_load(mice_file_list[[1]])

# clean_and_load

mice_data_list <- lapply(mice_file_list, clean_and_load)

scan_data_list <- lapply(scan_file_list, clean_and_load)

region_data_list <- lapply(regions_file_list, clean_and_load)

# Putting Everything Together

combined_data <- bind_rows(mice_data_list) %>%
  filter(!grepl("roi", id)) %>%
  mutate(id = gsub(" ", "", id, fixed = TRUE)) %>%
  separate(id, 
           into = c("Animal", "Cell_Group", "Cell_Location", "Number"), 
           sep = "_", remove=FALSE) %>%
  mutate(Cell_Group = toupper(Cell_Group),
         Cell_GroupNum = paste0(Cell_Group, Number),
         Cell_Location = case_when(
           Cell_Location == "nuc"  ~ "Nucleus",
           Cell_Location == "cyt" ~ "Cytosol",
           TRUE ~ NA),
         Cell_Type = paste(Cell_Group, Number, Cell_Location),
         Cell_Type = factor(Cell_Type,
                                   levels = mixedsort(unique(Cell_Type)))) %>%
  relocate(c(Cell_Type, Cell_GroupNum), .before = P)

 
combined_scans <- bind_rows(scan_data_list) %>%
  mutate(id = gsub(" ", "", id, fixed = TRUE)) %>%
  separate(id, 
           into = c("Cell_Scan", "Animal", "Cell_Group", "Cell_Location", "Number"), 
           sep = "_", remove=FALSE) %>%
  mutate(Cell_Group = toupper(Cell_Group),
         Cell_GroupNum = paste0(Cell_Group, Number),
         Cell_Location = case_when(
           Cell_Location == "nuc"  ~ "Nucleus",
           Cell_Location == "cyt" ~ "Cytosol",
           TRUE ~ NA),
         Cell_Type = paste(Cell_Group, Number, Cell_Location),
         Cell_Type = factor(Cell_Type,
                                   levels = mixedsort(unique(Cell_Type))),
         Cell_ScanGroup = paste(Cell_Group, Cell_Location,Cell_Scan)) %>%
  relocate(c(Cell_Type, Cell_GroupNum, Cell_ScanGroup), .before = P)

combined_scans <- combined_scans %>%
  # for now we don't need scan C data
  filter(!Cell_Scan == "compC")

combined_regions <- bind_rows(region_data_list) %>%
  filter(!grepl("roi", id)) %>%
  mutate(id = gsub(" ", "", id, fixed = TRUE),
         id = gsub("(\\d+)$", "_\\1", id),
         id = gsub("__", "_", id),
         id = gsub("interspersed", "inter", id)) %>%
  separate(id, 
           into = c("Animal", "Region", "Number"), 
           sep = "_", remove=FALSE) %>%
  mutate(Region = case_when(
          Region == "inter" ~ "Interspersed",
          Region == "crypt" ~ "Crypt",
          TRUE ~ NA), 
    Cell_RegionNum = paste(Region, Number),
    Cell_Group = Region,
    Cell_RegionNum = factor(Cell_RegionNum,
                       levels = mixedsort(unique(Cell_RegionNum)))) %>%
  relocate(c(Cell_RegionNum, Cell_Group), .before = P)

# Labeling
var_label(combined_data) <- list(Cell_Group = "Cell Group",
                                 Cell_Type = "Cell Type",
                                 Cell_Location = "Cell Location")
var_label(combined_regions) <- list(Cell_Group = "Tissue Region",
                                 Cell_RegionNum = "Cell Tissue Type")
var_label(combined_scans) <- list(Cell_Group = "Cell Group",
                                 Cell_Type = "Cell Type",
                                 Cell_ScanGroup = "Cell Type/Scan")

# Random Checks
# unique(combined_regions$Cell_Group)
# unique(normaldat_element$P == scale(combined_data$P))
# unique(normaldat_elementcell$P[normaldat_elementcell$Cell_Group=="VC"] == scale(combined_data$P[combined_data$Cell_Group=="VC"]))
# combined_data %>% View()
# mice_data_list[[4]][]
# 
# var_label(combined_data)
# 
# animal_data <- combined_data %>% filter(Animal == "J")
# 
# var_label(animal_data)
# 
#  ggplot(data = animal_data, aes(y = Cell_Type, 
#                                     x = Cell_Group, fill = Cell_Location)) +
#         easy_labs() +
#    
#         geom_boxplot() + 
#         ggtitle(paste("Animal",animal)) +
#         theme_bw() + 
#         theme(legend.position='bottom') +
#         scale_fill_discrete(guide = guide_legend(nrow = 4)) 
#  
# check <- data.frame(og = combined_data$Cell_Type,
#                     level = factor(combined_data$Cell_Type,
#                                    levels = mixedsort(unique(combined_data$Cell_Type))),
#                     label = factor(combined_data$Cell_Type,
#                                    labels = mixedsort(unique(combined_data$Cell_Type))))
# 
# check
```

```{r functions}
##-------- PRE-DEFINED FUNCTIONS TO USE IN ANALYSIS --------##

# Define a function to perform ANOVA and Tukey's HSD test
perform_anova_all <- function(data, element, animal_id, cell_type_list) {
  results <- list()
  
  # Loop through each list of cell types for the current animal and element
  for (cell_type in cell_type_list) {
    # Filter data for the current list of cell types
    data_filtered <- data %>%
                      filter(Cell_Type %in% cell_type) %>%
                      mutate(Cell_Type = droplevels(Cell_Type)) 
    
    # Get unique cell types after filtering to ensure they are part of the results
    cell_type_temp <- unique(data_filtered$Cell_Type)
    
    # Ensure there are enough data points to perform ANOVA
      # Define and fit the ANOVA model
      anova_model <- aov(as.formula(paste(element, "~ Cell_Type")), data = data_filtered)
      summary_anova <- summary(anova_model)
      # ad_model <- ad.test(as.formula(paste0("as.numeric(", element, ") ", "~ as.factor(Cell_Type)")), data = data_filtered)
      
      # Store ANOVA results using the unique cell types as the key
      results[paste("ANOVA", paste(cell_type_temp, collapse = "_"), sep = "_")] <- list(ANOVA = summary_anova)
      # results[paste("AD", paste(cell_type_temp, collapse = "_"), sep = "_")] <- list(ANOVA = ad_model)
  }
  
  # Return results including all analyzed cell types for this element and animal
  return(list(Animal = animal_id, Element = element, Results = results))
}


# Boxplot Function
boxplots <- function(data, fill = Cell_Group) {
  
  cutoff_plots_groups <- list()
  elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")
  individual <- list()
    for (metal in elements) {
      plots <- list()
      
      for (animal in unique(data$Animal)){
      animal_data <- data %>% filter(Animal == animal)

      plots[[paste(animal)]] <- ggplot(data = animal_data, 
                                aes(y = .data[[metal]], 
                                    x = Cell_Group, fill = {{fill}})) +
        geom_boxplot() + 
        ylim(min(data[[metal]]), quantile(data[[metal]], 0.996)) +
        ggtitle(paste("Animal",animal)) +
        theme_bw() + 
        theme(legend.position='bottom') +
        scale_fill_discrete(guide = guide_legend(
          nrow = ceiling(length(unique(data %>% pull({{fill}})))/7))) +
        ggeasy::easy_labs()
      
      individual[[paste(metal, animal)]] <- plots[[paste(animal)]] 
      }
      
      cutoff_plots_groups[[metal]] <- ggarrange(plotlist = plots,
                                      nrow = 2,
                                      ncol = 2,
                                      common.legend = FALSE,
                                      legend =  "bottom") 
        }
  return(list(plots = cutoff_plots_groups,
              individual = individual))
}

# Scan Boxplots
scan_boxplots <- function(data, fill = Cell_Group) {
  
  plot_final <- list()
  cutoff_plots_groups <- list()
  elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")
  
  for (group in unique(data$Cell_Group)){
    
    pre_dat <- data %>%
      filter(Cell_Group == group)
    
    for (metal in elements) {
      plots <- list()
      
      for (type in sort(unique(pre_dat$Cell_ScanGroup))){
      filtered_data <- pre_dat %>% filter(Cell_ScanGroup == type)
      
      plots[[type]] <- ggplot(data = filtered_data, 
                                aes(y = .data[[metal]], 
                                    x = Cell_Group, fill = {{fill}})) +
        geom_boxplot() + 
        ylim(min(data[[metal]]), quantile(data[[metal]], 0.996)) +
        ggtitle(paste(type)) +
        theme_bw() + 
        theme(legend.position='bottom') +
        scale_fill_discrete(guide = guide_legend(
          nrow = ceiling(length(unique(data %>% pull({{fill}})))/7))) +
        ggeasy::easy_labs()
      }
      
      cutoff_plots_groups[[metal]] <- ggarrange(plotlist = plots,
                                      # nrow = 2,
                                      # ncol = 2,
                                      common.legend = FALSE,
                                      legend =  "bottom")
    }
    
  plot_final[[group]] <- cutoff_plots_groups
  
  }
  return(plot_final)
}

# Violin Function
violin <- function(data, fill = Cell_Group) {
  
  cutoff_plots_groups <- list()
    for (metal in elements) {
      plots <- list()
      
      for (animal in unique(data$Animal)){
      animal_data <- data %>% filter(Animal == animal)
      
      plots[[animal]] <- ggplot(data = animal_data, 
                                aes(y = .data[[metal]], 
                                    x = Cell_Group, fill = {{fill}})) +
        geom_violin() + 
        ylim(min(animal_data[[metal]]), quantile(animal_data[[metal]], 0.996)) +
        ggtitle(paste("Animal",animal)) +
        theme_bw() + 
        theme(legend.position='bottom') +
        scale_fill_discrete(guide = guide_legend(nrow = 2)) +
        ggeasy::easy_labs()
      }
      
      cutoff_plots_groups[[metal]] <- ggarrange(plots$B,
                                      plots$F,
                                      plots$H,
                                      plots$J,
                                      nrow = 2,
                                      ncol = 2,
                                      common.legend = FALSE,
                                      legend =  "bottom")
        }
  return(cutoff_plots_groups)
}

# Run Umap (if needed)
run_umap <- function(data = combined_data, date = date){

  # Plotting Umap
  # Takes very long to run - saving as .RData object so I can load it in next session
  
  # Umap for all data
  data_umap_all <- umap(dplyr::select(data, P:Zn))
  
  # # Umap for IC Cells
  # IC_cells <- data[grepl("IC", data$`Cell_Group`), ]
  # data_umap_IC <- umap(IC_cells[2:7])
    
  save(data_umap_all, file = file.path(fpath,
                                                     paste(deparse(substitute(data)),
                                                     date,
                                                     "umap.RData",
                                                     sep = "_")))
}
```

```{r anova}
hypothesis_1_anova <- function(hypothesis1 = combined_data){
  
# Hypothesis 1: Intra-animal Variability Analysis
  # A. Analysis of Variance (ANOVA)
  # For each element within each cell type across different cells of the same type within an animal, we'll conduct an ANOVA to test for significant differences.
  
  # Elements to test
  elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")
  
  # Data files and their respective animal identifiers
  data_files <- list(B = hypothesis1[hypothesis1$Animal == "B",], 
                     F = hypothesis1[hypothesis1$Animal == "F",], 
                     H = hypothesis1[hypothesis1$Animal == "H",], 
                     J = hypothesis1[hypothesis1$Animal == "J",])
  
  # Cell types and their identifiers
  cell_types <- list(
    IC = unique(grep("IC",combined_data$Cell_Type, value = TRUE)),
    CC = unique(grep("CC",combined_data$Cell_Type, value = TRUE)),
    VC = unique(grep("VC",combined_data$Cell_Type, value = TRUE)))
  
  # Loop through each dataset and perform ANOVA for each element and cell type group
  anova_outputs <- list()
  for (animal in names(data_files)) {
    for (element in elements) {
        anova_outputs[[paste(animal, element, sep = "_")]] <- perform_anova_all(data_files[[animal]], element, animal, cell_types)
      }
  }
  
  # Making it into a table (so as to not change the original function)
  test_results <- list()
  for (animal_element_label in unique(names(anova_outputs))){
    for (test in c("ANOVA", "AD")){
    cell_names <-  grep(test, names(anova_outputs[[animal_element_label]]$Results), value = TRUE)
    for (label in cell_names){
      name <- paste(animal_element_label, label)
      
        if (grepl("AD", label)) {
          p_value <- as.numeric(anova_outputs[[animal_element_label]]$Results[[label]]$ad[," asympt. P-value"][1])}
          
        else {
          p_value <- anova_outputs[[animal_element_label]]$Results[[label]][[1]][["Pr(>F)"]][1]}
        
      test_results[[test]][[name]]  <-   data.frame(
                                            animal = substring(anova_outputs[[animal_element_label]]$Animal, 1, 1),
                                            cell = label,
                                            element = anova_outputs[[animal_element_label]]$Element,
                                            p_value = p_value) %>%
                                            mutate(group = case_when(
                                            grepl("ic", cell, ignore.case = TRUE) ~ "IC",
                                            grepl("cc", cell, ignore.case = TRUE) ~ "CC",
                                            grepl("vc", cell, ignore.case = TRUE) ~ "VC"))
     }
    }
  }
  
  # Make into report table
  anova_tbl <- dplyr::bind_rows(test_results$ANOVA) %>%
    mutate(p_value = p.adjust(p_value, method="BH")) %>%
    mutate(p_value = case_when(
      p_value > 0.01 ~ as.character(round(p_value, 2)),
      p_value < 0.001 ~ "<0.001",
      is.na(p_value) ~ NA,
      TRUE ~ as.character(round(p_value, 3)))) %>%
    pivot_wider(id_cols = c(animal, element), 
                values_from=p_value, names_from=group) 
  
  # ad_tbl <- dplyr::bind_rows(test_results$AD) %>%
  #   mutate(p_value = p.adjust(p_value, method="BH")) %>%
  #   mutate(p_value = if_else(p_value < 0.0001, "<0.0001", as.character(round(p_value, 5)))) %>%
  #   pivot_wider(id_cols = c(animal, element),
  #               values_from=p_value, names_from=group)
  

  # 2: Hypothesis 1B: Ignoring Metal
    # 6 columns to 1 -> make data long 
  
  # Making Data Long
  long_data <- hypothesis1 %>%
    pivot_longer(cols=P:Zn,
                 names_to = "Element",
                 values_to = "Expression")
  
  # Getting new data files var
  data_files_long <- list(B = long_data[long_data$Animal == "B",],
                          F = long_data[long_data$Animal == "F",], 
                          H = long_data[long_data$Animal == "H",], 
                          J = long_data[long_data$Animal == "J",])
  
  # Putting everything into a list
  anova_long_outputs <- list()
  for (animal in names(data_files_long)) {
        anova_long_outputs[[paste(animal)]] <- perform_anova_all(data_files_long[[animal]], "Expression", animal, cell_types)
  }
  
  # Making it into a table (so as to not change the original function)
  test_results_long <- list()
  for (animal_element_label in unique(names(anova_long_outputs))){
    for (test in c("ANOVA", "AD")){
    cell_names <-  grep(test, names(anova_long_outputs[[animal_element_label]]$Results), value = TRUE)
    for (label in cell_names){
      name <- paste(animal_element_label, label)
      
        if (grepl("AD", label)) {
          p_value <- as.numeric(anova_long_outputs[[animal_element_label]]$Results[[label]]$ad[," asympt. P-value"][1])}
          
        else {
          p_value <- anova_long_outputs[[animal_element_label]]$Results[[label]][[1]][["Pr(>F)"]][1]}
        
      test_results_long[[test]][[name]]  <- data.frame(
                                            animal = substring(anova_long_outputs[[animal_element_label]]$Animal, 1, 1),
                                            cell = label,
                                            element = anova_long_outputs[[animal_element_label]]$Element,
                                            p_value = p_value) %>%
                                            mutate(group = case_when(
                                            grepl("ic", cell, ignore.case = TRUE) ~ "IC",
                                            grepl("cc", cell, ignore.case = TRUE) ~ "CC",
                                            grepl("vc", cell, ignore.case = TRUE) ~ "VC"))
     }
     }
    }
  
  
  # Make into report table
  anova_tbl_long <- dplyr::bind_rows(test_results_long$ANOVA) %>%
    mutate(p_value = p.adjust(p_value, method="BH")) %>%
    mutate(p_value = case_when(
      p_value > 0.01 ~ as.character(round(p_value, 2)),
      p_value < 0.001 ~ "<0.001",
      is.na(p_value) ~ NA,
      TRUE ~ as.character(round(p_value, 3)))) %>%
    pivot_wider(id_cols = animal, 
                values_from=p_value, names_from=group) 
  
  # ad_tbl_long <- dplyr::bind_rows(test_results_long$AD) %>%
  #   mutate(p_value = p.adjust(p_value, method="BH")) %>%
  #   mutate(p_value = if_else(p_value < 0.0001, "<0.0001", as.character(round(p_value, 5)))) %>%
  #   pivot_wider(id_cols = animal,
  #               values_from=p_value, names_from=group)
  
  return(list(anova_tbl = anova_tbl,
              # ad_tbl = ad_tbl,
              anova_tbl_long = anova_tbl_long))
              # ad_tbl_long = ad_tbl_long))
}
```

```{r umap}
# Hypothesis 3: Cluster Analysis for IC Cells - Assuming it has already been run
hypothesis_3 <- function(hypothesis3 = combined_data,
                         hypothesis3_all = data_umap_all,
                         panel_by = combined_data$Cell_Location){
                         #this should be something like combined_data$Cell_Location

 # Getting Dataframes of All Data
  data_umap_plot <- data.frame(x = hypothesis3_all$layout[,1],
                   y = hypothesis3_all$layout[,2],
                   cell_type = hypothesis3$Cell_Type,
                   cell_group = hypothesis3$Cell_Group,
                   animal_label = hypothesis3$Animal,
                   panel_by = panel_by)
  
  # Writing Labels
  var_label(data_umap_plot) <- list(cell_group = "Cell Group",
                                 cell_type = "Cell Type")
  
  
# Cell Group Panel  
  cell_group_list <- list()
  cell_group_plots <- list()
  cell_type_list <- list()
  
  colours_group <- hue_pal()(length(unique(data_umap_plot$cell_group)))
  names(colours_group) <- sort(unique(data_umap_plot$cell_group))
  
  colours_panel <- hue_pal()(length(unique(panel_by)))
  names(colours_panel) <- sort(unique(panel_by))
      
  for (group in sort(unique(data_umap_plot$cell_group))){
    
      data_grouped <- data_umap_plot %>%
        filter(cell_group %in% group)
      
      # Cell Groups
      cell_type_list[[group]] <- 
        ggplot(data_grouped, aes(x, y)) +
        geom_point(alpha=0.6, size=0.5, colour = colours_group[group]) +
        theme_bw() + 
        xlim(min(data_umap_plot$x), quantile(data_umap_plot$x, 0.999)) + 
        ylim(min(data_umap_plot$y), quantile(data_umap_plot$y, 0.999)) +
        # guides(colour = guide_legend(override.aes = list(size=2),
        #                 nrow = ceiling(length(unique(data_grouped$cell_type))/9))) + 
        # guides(shape = guide_legend(override.aes = list(size = 2))) +
        # theme(legend.title = element_text(size = 5), 
        #       legend.text  = element_text(size = 5),
        #       legend.key.size = unit(0.1, "lines")) +
        # theme(legend.position='bottom') +
        ggtitle(paste(group)) +
        easy_labs()
      
      for(panel in unique(panel_by)) {

        data <- data_grouped %>%
          filter(grepl(panel, panel_by))

      # Cell Groups
      cell_group_list[[panel]] <-
        ggplot(data, aes(x, y)) +
        geom_point(alpha=0.6, size=0.5, colour = colours_panel[panel]) +
        theme_bw() +
        xlim(min(data_umap_plot$x), quantile(data_umap_plot$x, 0.999)) +
        ylim(min(data_umap_plot$y), quantile(data_umap_plot$y, 0.999)) +
        # guides(colour = guide_legend(override.aes = list(size=4),
        #                 nrow = ceiling(length(unique(data$cell_type))/5))) +
        # guides(shape = guide_legend(override.aes = list(size = 3.5))) +
        # theme(legend.title = element_text(size = 5),
        #       legend.text  = element_text(size = 5),
        #       legend.key.size = unit(0.4, "lines"))
        # theme(legend.position='bottom') +
        ggtitle(paste(panel, group)) +
        easy_labs()}

      cell_group_plots[[group]] <- ggarrange(plotlist = cell_group_list,
                                    ncol = 2,
                                    nrow = ceiling(length(unique(panel_by))/2),
                                    legend = "bottom")}
        
      cell_type_panel <- ggarrange(plotlist = cell_type_list,
                                    ncol = 2, 
                                   nrow = ceiling(length(unique(data_umap_plot$cell_group))/2),
                                   legend = "bottom")

# Animal Groups

      # Animal Group Panel

      animal_group_panel <- list()

      colours <- hue_pal()(length(unique(data_umap_plot$animal_label)))
      names(colours) <- c("B", "F", "H", "J")

      for (animal in c("B", "F", "H", "J")){

      data <- filter(data_umap_plot, animal_label == animal)

      animal_group_panel[[animal]] <- ggplot(data, aes(x, y)) +
             geom_point(alpha=0.6, size=0.5, colour = colours[animal]) +
             theme_bw() +
             xlim(min(data_umap_plot$x), quantile(data_umap_plot$x, 0.999)) +
             ylim(min(data_umap_plot$y), quantile(data_umap_plot$y, 0.999)) +
             ggtitle(paste("Mouse", animal)) +
             easy_labs()}

      animal_group_panel <- ggarrange(plotlist = animal_group_panel)

      # Cells Paneled by Animal

      animal_cell_groups_panel <- list()
      animal_cell_groups <- list()
      colours <- hue_pal()(length(unique(data_umap_plot$animal_label)))
      names(colours) <- c("B", "F", "H", "J")

        for (group in sort(unique(data_umap_plot$cell_group))){
          for(panel in unique(panel_by)) {
          dat_filtered <- data_umap_plot %>%
              filter(cell_group %in% group &
                     grepl(panel, cell_type))

          for (animal in c("B", "F", "H", "J")){

          data <- filter(dat_filtered, animal_label == animal)

          animal_cell_groups[[animal]] <- ggplot(data, aes(x, y)) +
                 geom_point(alpha=0.6, size=0.5, colour = colours[animal]) +
                 theme_bw() +
                 xlim(min(data_umap_plot$x), quantile(data_umap_plot$x, 0.999)) +
                 ylim(min(data_umap_plot$y), quantile(data_umap_plot$y, 0.999)) +
                 ggtitle(paste("Mouse", animal)) +
                 easy_labs()}

          animal_cell_groups_panel[[paste(group, panel)]] <- ggarrange(plotlist = animal_cell_groups) %>%
                                                  annotate_figure(top = text_grob(paste(group, panel)))}}

# Creating Images
for (i in names(cell_group_plots)){

  # Cell Groups
  png(file.path(image_path, paste0(deparse(substitute(hypothesis3)), "_", i,
                                   "_umap_cell_group_panel_", date, ".png")),
      width=11, height=9,  units="in", res = 500)

  print(cell_group_plots[[i]])

  dev.off()}

for (i in names(animal_cell_groups_panel)){
  # Animal Cell Groups
  png(file.path(image_path, paste0(deparse(substitute(hypothesis3)), "_", i,
                                   "_umap_animal_cell_group_panel_", date, ".png")),
      width=11, height=9,  units="in", res = 500)

  print(animal_cell_groups_panel[[i]])

  dev.off()}

  # Animal Groups Panel
  png(file.path(image_path, paste0(deparse(substitute(hypothesis3)),
                                   "_umap_animal_group_panel_", date, ".png")),
      width=10, height=8,  units="in", res = 500)

  print(animal_group_panel)

  dev.off()

    # Cell Type Panel
    png(file.path(image_path, paste0(deparse(substitute(hypothesis3)),
                                     "_umap_cell_type_panel_", date, ".png")),
        width=16, height=14,  units="in", res = 750)

    print(cell_type_panel)

    dev.off()

   return(list(cell_group_plots, animal_group_panel, cell_type_panel,animal_cell_groups, animal_cell_groups_panel))
  }


# cell_type_list$inter
# 
#  ggarrange(plotlist = cell_type_list,
#                                     ncol = 2, 
#                                    nrow = ceiling(length(unique(data_umap_plot$cell_group))/2),
#                                    legend = "bottom")
#  
#  
# cell_group_plots$inter
```

```{r running umap, eval = FALSE}
# Running Umap Images (if needed)

  # Umap data
    # Run Umap function
      # run_umap(data = combined_data, date = date)
      # run_umap(data=normaldat_elementcell, date = date)
      # run_umap(data=normaldat_animalelement, date = date)
       # run_umap(data=combined_regions, date = date)

# Loading in the .Rdata for graphing

# Raw Data
  # Getting Umap
  load(file.path(fpath, "combined_data_053024_umap.RData"))
  
  raw_umap <- hypothesis_3(hypothesis3 = combined_data)
 
# Interspersed/Crypt Data
  # Getting Umap
  load(file.path(fpath, "combined_regions_061824_umap.RData"))
  region_dat <- combined_regions %>%
                rename(Cell_Type = Cell_RegionNum) %>%
                mutate(animal_string = paste("Mouse", Animal))
  
  region_umap <- hypothesis_3(hypothesis3 = region_dat,
                              panel_by = region_dat$animal_string)
  
  region_dat2 <- combined_regions %>%
                mutate(Cell_Type = Cell_Group) %>%
                mutate(animal_string = paste("Mouse", Animal))
  
  region_umap2 <- hypothesis_3(hypothesis3 = region_dat2,
                              panel_by = region_dat2$animal_string)
  
  
# raw_umap[[3]]
```

\blandscape

# Analysis of Raw Data

## Data Summaries 

### Table 1

```{r, eval=TRUE, include = TRUE}
tbl_1_raw <- combined_data %>% 
  group_by(`Cell_Group`, Animal, Cell_Location) %>%
  summarize_at(c("P","S","Ca","Fe","Cu","Zn"), list(mean=mean, sd=sd)) %>%
  ungroup() %>%
  mutate(across(where(is.numeric), ~if_else(. < 0.01 & . > 0, round(.,4), round(.,2)))) 
  

elements <- sub("_.*", "", names(tbl_1_raw)[4:9])

for (prefix in elements){
  mean_col <- paste0(prefix, "_mean") 
  sd_col <- paste0(prefix, "_sd")
  
  new_var <- paste(tbl_1_raw[[mean_col]], 
                   " (", 
                   tbl_1_raw[[sd_col]],
                   ")", sep = "")

  
  tbl_1_raw <- dplyr::select(tbl_1_raw, !starts_with(prefix))
  tbl_1_raw[[prefix]] <- new_var
}

rbind(c(" ", " ", " ", "Mean (SD)", " ", " "," "," "," "), tbl_1_raw) %>% 
  kable("latex", booktabs = TRUE, 
        align = "c", longtable = TRUE, linesep = "",
        caption = "Mean Expression in Each Element by Cell Group and Animal") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                font_size = 11, position = "left")
```

\newpage

### Boxplots - Overall Cell Group and Cyt vs Nuc


```{r warning=FALSE}
# Elements to test
elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")

boxplots_combined <- boxplots(data = combined_data, fill = Cell_Location)
```

\newpage

```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("#### Boxplots of All Animals of", paste(metal))
  print(boxplots_combined$plots[[metal]])
}
```

### Boxplots - Cell Types split by Cyt and Nuc

\newpage

```{r warning=FALSE}
boxplots_combined_cyt <- boxplots(data = combined_data %>% filter(Cell_Location == "Cytosol"), fill = Cell_Type)
boxplots_combined_nuc <- boxplots(data = combined_data %>% filter(Cell_Location == "Nucleus"), fill = Cell_Type)
```


```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("##### Boxplots of All Animals of Cyt of", paste(metal))
  print(boxplots_combined_cyt$plots[[metal]])
  cat("##### Boxplots of All Animals of Nuc of", paste(metal))
  print(boxplots_combined_nuc$plots[[metal]])
}
```


### Boxplots - 8 Plot 

```{r warning=FALSE}
boxplot_8panel <- list()
for (metal in elements){
  boxplot_region <- list()
  for (region in c("cyt", "nuc")){
    for (animal in c("H", "B", "J", "F")){
     index <- paste(metal, animal)
      if (region == "cyt"){
      boxplot_region[[paste(index, region)]] <- boxplots_combined_cyt$individual[[index]] +
     theme(legend.position="none") +
     ggtitle(paste("Animal", animal, "- Cytosol"))}
      else {
      boxplot_region[[paste(index, region)]] <- boxplots_combined_nuc$individual[[index]] +
     theme(legend.position="none") +
     ggtitle(paste("Animal", animal, "- Nucleus"))}
    }
   # boxplot_region[[paste(index, "cyt")]] <- boxplots_combined_cyt$individual[[index]] +
   #   theme(legend.position="none") +
   #   ggtitle(paste("Animal", animal, "- Cytosol"))
   # boxplot_region[[paste(index, "nuc")]] <- boxplots_combined_nuc$individual[[index]] +
   #   theme(legend.position="none") +
   #   ggtitle(paste("Animal", animal, "- Nucleus"))
  }
  boxplot_8panel[[metal]] <- ggarrange(plotlist = boxplot_region,
          nrow = 2,
          ncol = 4)
}
```


\newpage

```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("##### Boxplots of All Animals and Regions by Cell Type of ", paste(metal))
  print(boxplot_8panel[[metal]])
}
```

\elandscape

## Intra-animal Variability Analysis
For each element within each cell type across different cells of the same type within an animal, we'll conduct an ANOVA to test for significant differences. All analyses have FDR adjusted p-values corrected to account for multiple testing.

```{r}
analysis_1 <- hypothesis_1_anova(hypothesis1 = combined_data)
```

### ANOVA

```{r}
analysis_1$anova_tbl %>% 
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "All Anova P-Values For Each Animal and Cell Group Subset on Each Element Expression") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```

```{r}
analysis_1$anova_tbl_long %>% 
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "Anova P-Values for Cell Group and Animal Combination (Ignoring Element Type)") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```

\newpage

<!-- ### Anderson-Darling test -->
<!-- This test compares the distribution of samples. -->

<!-- ```{r} -->
<!-- analysis_1$ad_tbl %>%  -->
<!--   kable("latex", booktabs = TRUE,  -->
<!--         align = "l", longtable = TRUE, linesep = "", -->
<!--         caption = "Anderson-Darling P-Values For Each Animal and Cell Group Subset on Each Element Expression") %>% -->
<!--   kable_styling(full_width = FALSE,  -->
<!--                 latex_options = c("striped", "repeat_header"), -->
<!--                 position = "center") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- analysis_1$ad_tbl_long %>%  -->
<!--   kable("latex", booktabs = TRUE,  -->
<!--         align = "l", longtable = TRUE, linesep = "", -->
<!--         caption = "Anderson-Darling P-Values for Cell Group and Animal Combination (Ignoring Element Type)") %>% -->
<!--   kable_styling(full_width = FALSE,  -->
<!--                 latex_options = c("striped", "repeat_header"), -->
<!--                 position = "center") -->
<!-- ``` -->

\newpage

## Cluster Analysis
Using UMap to reduce dimensions and assess groupings of cells and animals based on expression

```{r}
file_date <- "072924"
```


### All Dat Cell Groups

![](`r file.path(image_path, paste0("combined_data_umap_cell_type_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_CC_umap_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_IC_umap_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_VC_umap_cell_group_panel_", file_date, ".png"))`)

\newpage

### All Dat Animal Groups

![](`r file.path(image_path, paste0("combined_data_umap_animal_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_CC Nucleus_umap_animal_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_IC Nucleus_umap_animal_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_IC Cytosol_umap_animal_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_VC Nucleus_umap_animal_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("combined_data_VC Cytosol_umap_animal_cell_group_panel_", file_date, ".png"))`)

\newpage

\blandscape

# Same Cells Different Step Scans

## Data Summaries 

### Table 1

```{r, eval=TRUE, include = TRUE}
tbl_1_scan <- combined_scans %>% 
  group_by(`Cell_Group`, Cell_Scan, Cell_Location) %>%
  summarize_at(c("P","S","Ca","Fe","Cu","Zn"), list(mean=mean, sd=sd)) %>%
  ungroup() %>%
  mutate(across(where(is.numeric), ~if_else(. < 0.01 & . > 0, round(.,4), round(.,2)))) 
  

elements <- sub("_.*", "", names(tbl_1_scan)[4:9])

for (prefix in elements){
  mean_col <- paste0(prefix, "_mean") 
  sd_col <- paste0(prefix, "_sd")
  
  new_var <- paste(tbl_1_scan[[mean_col]], 
                   " (", 
                   tbl_1_scan[[sd_col]],
                   ")", sep = "")

  
  tbl_1_scan <- dplyr::select(tbl_1_scan, !starts_with(prefix))
  tbl_1_scan[[prefix]] <- new_var
}

tbl_1_scan <- tbl_1_scan %>%
  arrange(Cell_Group, Cell_Location)

rbind(c(" ", " ", " ", "Mean (SD)", " ", " "," "," "," "), tbl_1_scan) %>% 
  kable("latex", booktabs = TRUE, 
        align = "c", longtable = TRUE, linesep = "",
        caption = "Mean Expression in Each Element by Cell Group and Animal") %>%
  column_spec(1:3, width = "4em") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                font_size = 10, position = "left")
```

\newpage


### Boxplots - IC Cells

\newpage

```{r warning=FALSE}
elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")

boxplots_all <- scan_boxplots(data = combined_scans, fill = Cell_GroupNum)
```

```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("#### Boxplots of IC Cells/Location for", paste(metal))
  print(boxplots_all$IC[[metal]])
}
```

### Boxplots - CC Cells

\newpage

```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("#### Boxplots of CC Cells/Location for", paste(metal))
  print(boxplots_all$CC[[metal]])
}
```

\elandscape

## T-Test Between Scan A and Scan B
```{r}
 # Loop through each dataset and perform ttest for each element and cell type group

ttest_output <- list() 
ttest_results <- list()
pct_diff_list <- list()
    for (cell_type in unique(combined_scans$Cell_Type)){
      data <- combined_scans %>%
        filter(Cell_Type == cell_type)
      for (metal in unique(elements)){
      
      ttest <- t.test(data[metal][data$Cell_Scan == "compA",],
                      data[metal][data$Cell_Scan == "compB",])
      
      ttest_output[[metal]][cell_type] <- list(ttest = ttest)
      ttest_results[[paste(metal, cell_type, sep = "_")]] <- data.frame(
                                  Cell_Type = cell_type,
                                  Element = metal,
                                  P_Value = ttest$p.value)
      
      pct_diff <- abs(((median(data[metal][data$Cell_Scan == "compA",]) - median(data[metal][data$Cell_Scan == "compB",]))/
                      median(data[metal][data$Cell_Scan == "compA",])))
    
      pct_diff_list[[paste(metal, cell_type, sep = "_")]] <- data.frame(
                                  Cell_Type = cell_type,
                                  Element = metal,
                                  pct_diff = pct_diff)
      
      }
     
    }

ttest_results_tbl <- dplyr::bind_rows(ttest_results) %>%
    mutate(P_Value = p.adjust(P_Value, method="BH")) %>%
    mutate(P_Value = case_when(
      P_Value > 0.01 ~ as.character(round(P_Value, 2)),
      P_Value < 0.001 ~ "<0.001",
      is.na(P_Value) ~ NA,
      TRUE ~ as.character(round(P_Value, 3)))) %>%
    pivot_wider(id_cols = c(Cell_Type), 
                values_from=P_Value, names_from=Element) 

ttest_results_tbl %>% 
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "T-Test P-Values Between Scan A and Scan B For Different Cell Group Types") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```

\newpage

## Absolute Difference Between Median of Comp A vs Comp B
```{r}
pct_diff_data <- dplyr::bind_rows(pct_diff_list) %>%
    pivot_wider(id_cols = c(Cell_Type), 
                values_from=pct_diff, names_from=Element)

pct_diff_data %>% 
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "Absolute Percent Differences Between Scan A and Scan B For Different Cell Group Types") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```

\newpage 

## T-Test Alone Same/Different
```{r}
ttest_data <- dplyr::bind_rows(ttest_results) %>% 
    mutate(P_Value = p.adjust(P_Value, method="BH")) %>%
    pivot_wider(id_cols = c(Cell_Type), 
                values_from=P_Value, names_from=Element)


ttest_0.05 <- ttest_data %>%
  mutate(across(P:Zn, ~ if_else((. < 0.05),
           "Different", "Same")))

ttest_0.05 %>% 
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "T-Test Differences (0.05 cutoff)") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```

## Conditions of 5% Change in Median + Significant T-Test for Comp A vs Comp B

```{r}
conditional_data <- ttest_data %>%
    left_join(pct_diff_data, by = "Cell_Type", suffix = c(".test", ".diff"))

conditional_list <- list()
for (metal in elements){
  data <- conditional_data %>%
    select(Cell_Type, starts_with(metal)) %>% 
    rename_with(~ "ttest", contains(".test")) %>% 
    rename_with(~ "pctdiff", contains(".diff"))
  
  conditional_list[[metal]] <- data %>% 
    mutate(!!metal := if_else((ttest < 0.05 & pctdiff > 0.05),
           "Different", "Same"))
}


conditional_tbl <- dplyr::bind_cols(conditional_list) %>%
    select(Cell_Type = "Cell_Type...1",
           all_of(elements)) 

conditional_tbl %>%
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "Conditions Applied To Differences Between Scan A and B") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```

# Interspersed versus Crypt Cell Data

## Data Summaries 

### Table 1

```{r, eval=TRUE, include = TRUE}
tbl_1_region <- combined_regions %>% 
  group_by(Animal,`Region`) %>%
  summarize_at(c("P","S","Ca","Fe","Cu","Zn"), list(mean=mean, sd=sd)) %>%
  ungroup() %>%
  mutate(across(where(is.numeric), ~if_else(. < 0.01 & . > 0, round(.,4), round(.,2)))) 
  

elements <- sub("_.*", "", names(tbl_1_region)[3:8])

for (prefix in elements){
  mean_col <- paste0(prefix, "_mean") 
  sd_col <- paste0(prefix, "_sd")
  
  new_var <- paste(tbl_1_region[[mean_col]], 
                   " (", 
                   tbl_1_region[[sd_col]],
                   ")", sep = "")

  
  tbl_1_region <- dplyr::select(tbl_1_region, !starts_with(prefix))
  tbl_1_region[[prefix]] <- new_var
}

rbind(c(" ", " ", "Mean (SD)", " ", " "," "," "," "), tbl_1_region) %>% 
  kable("latex", booktabs = TRUE, 
        align = "c", longtable = TRUE, linesep = "",
        caption = "Mean Expression in Each Element by Cell Region and Animal") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                font_size = 11, position = "left")
```

\blandscape

### Boxplots - Overall Crypts versus Interspersed

\newpage

```{r warning=FALSE}
elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")

boxplots_region_overall <- boxplots(combined_regions, fill = Cell_Group)
```

```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("#### Boxplots of Overall Interspersed versus Crypt Cells for", paste(metal))
  print(boxplots_region_overall$plots[[metal]])
}
```

\newpage


### Boxplots - Crypts versus Interspersed Groups

\newpage

```{r warning=FALSE}
elements <- c("P", "S", "Ca", "Fe", "Cu", "Zn")

boxplots_region <- boxplots(combined_regions, fill = Cell_RegionNum)
```

```{r echo=FALSE, fig.align='center', fig.height=12, fig.width=18, include=TRUE, results = 'asis'}
for (metal in elements){
  # cat(paste0("\n"))
  cat("#### Boxplots of Interspersed versus Crypt Cells for", paste(metal))
  print(boxplots_region$plots[[metal]])
}
```

\elandscape

## Anderson-Darling Test

```{r eval=FALSE}
# ad_results <- list()
# for (animal in unique(combined_regions$Animal)) {
#   for (element in elements){
#   data_filtered <- combined_regions %>% 
#                     filter(Animal %in% animal)
#   
#   ad_results[[paste0(animal, "_", element)]]  <- ad.test(as.formula(paste0("as.numeric(", element, ") ",
#                                                                            "~ as.factor(Region)")), 
#                                                          data = data_filtered)
#   }
# }
# 
# save(ad_results, file = file.path(fpath, paste0("adresults_original_",
#                                                      date,
#                                                      ".RData")))

ad_results2 <- list()
for (animal in unique(combined_regions$Animal)) {
  for (element in elements){
  data_filtered <- combined_regions %>% 
                    filter(Animal %in% animal)
  
  ad_results2[[paste0(animal, "_", element)]]  <- 
    twosamples::ad_test(data_filtered[data_filtered$Region == "Crypt",][[element]],
                    data_filtered[data_filtered$Region == "Interspersed",][[element]])
  }
}

save(ad_results2, file = file.path(fpath, paste0("adresults_",
                                                     date,
                                                     ".RData")))
```


```{r}
load(file.path(fpath, "adresults_071424.RData"))

# load(file.path(fpath, "adresults_original_071524.RData"))

test_results <- list()
  for (label in names(ad_results2)){
          test_results[[label]] <- ad_results2[[label]]["P-Value"]}

# test_results <- list()
#   for (label in names(ad_results2)){
#           test_results[[label]] <- list(`P-Value` = ad_results[[label]]$ad[," asympt. P-value"][1])}

# Make into report table
ad_tbl <- dplyr::bind_rows(test_results) %>%
    mutate(id = names(test_results),
           p_value = p.adjust(`P-Value`, method="BH")) %>%
    mutate(p_value = case_when(
      p_value > 0.01 ~ as.character(round(p_value, 2)),
      p_value < 0.001 ~ "<0.001",
      is.na(p_value) ~ NA,
      TRUE ~ as.character(round(p_value, 3))),
      animal = sub("_.*$", "", id),
      element = sub("^[^_]*_", "", id)) %>%
    pivot_wider(id_cols = animal, 
                values_from=p_value,
                names_from = element) 

ad_tbl %>%
  kable(booktabs = TRUE, 
        align = "l", longtable = TRUE, linesep = "",
        caption = "Anderson Darling Test for Crypt vs Inter") %>%
  kable_styling(full_width = FALSE, 
                latex_options = c("striped", "repeat_header"),
                position = "center")
```


## Clustered Analysis Version 1

```{r}
file_date <- "071424"
```


### Region Data Cell Groups

![](`r file.path(image_path, paste0("region_dat_umap_cell_type_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("region_dat_Crypt_umap_cell_group_panel_", file_date, ".png"))`)

\newpage

![](`r file.path(image_path, paste0("region_dat_Interspersed_umap_cell_group_panel_", file_date, ".png"))`)

\newpage

### Region Dat Animal Groups

![](`r file.path(image_path, paste0("region_dat_umap_animal_group_panel_", file_date, ".png"))`)


\newpage

## Clustered Analysis Version 2


### Region Data Cell Groups

![](`r file.path(image_path, "region_dat2_umap_cell_type_panel_071424.png")`)

\newpage

![](`r file.path(image_path, "region_dat2_Crypt_umap_cell_group_panel_071424.png")`)

\newpage

![](`r file.path(image_path, "region_dat2_Interspersed_umap_cell_group_panel_071424.png")`)

\newpage

### Region Dat Animal Groups

![](`r file.path(image_path, "region_dat2_umap_animal_group_panel_071424.png")`)


\newpage

```{r boxplots, eval = FALSE, include=FALSE}
# exporting all boxplots to output
all_plots <- c(ls()[grepl("boxplot", ls())])
all_plots <- all_plots[!(all_plots=="boxplots" | all_plots=="scan_boxplots")]
names(all_plots) <- all_plots

for (i in names(all_plots)){  
  bp_list <- get(all_plots[i])
  
  # Some contain plot in the plots index only
  if (!is.null(bp_list$plots)) {
    bp_list <- bp_list$plots}
  
  if (i == "boxplots_all"){
    bp_list2 <- list()
      for (metal in elements){
      bp_list2[[paste0("IC_", metal)]] <- bp_list$IC[[metal]]
      bp_list2[[paste0("CC_", metal)]] <- bp_list$CC[[metal]]
      }
    bp_list <- bp_list2
  }
  
  for (plot in names(bp_list)){
  # Creating Images
    png(file.path(image_path, paste0(i, "_", plot,"_", date, ".png")),
        height=18, width=30, units="in", res=500)
    
    print(bp_list[[plot]] + theme(text = element_text(size=rel(5.7))))

    dev.off()}
  }
```

```{r tables, eval = FALSE, include=FALSE}
library(flextable)
library(officer)

# Exporting as Word Document
 # Options for formatting
sect_properties <- officer::prop_section(
  page_size = officer::page_size(
    # orient = "landscape",
    width = 8.3, height = 11.7),
  type = "nextPage",
  page_margins = officer::page_mar(left=.1)
)

# Output tables for Presentation
flextable::save_as_docx(

  'Table 1 for Raw Data'  = 
    tbl_1_raw %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),
  
  'All Anova PValues For Each Animal and Cell Group Subset
on Each Element Expression' = 
    analysis_1$anova_tbl %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),

    'Anova PValues for Cell Group and Animal Combination
(Ignoring Element Type)' = 
    analysis_1$anova_tbl_long %>% 
    flextable() %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),
  
  'Table 1 for Scan Data'  = 
    tbl_1_scan %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),
  
    'TTest PValues Between Scan A and Scan B For Different
Cell Group Types' = 
    ttest_results_tbl %>% 
    flextable() %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),
  
    'Absolute Percent Differences Between Scan A and Scan B
For Different Cell Group Types' = 
    pct_diff_data %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),
  
      'TTest Differences (0.05 cutoff)' = 
    ttest_0.05 %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),
  
      'Conditions Applied To Differences Between Scan A and B' = 
    conditional_tbl %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),

    'Table 1 for Region Data'  = 
    tbl_1_region %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),

        'Anderson Darling Test for Crypt vs Inter' = 
    ad_tbl %>% 
    flextable()  %>% 
    autofit() %>% 
    set_table_properties(layout = "autofit") %>% 
    border_inner_h(border = officer::fp_border()),

  path = file.path(image_path, paste0("tables_", date, ".docx")), 
  pr_section = sect_properties,
  align = "center")
```

```{r eval=FALSE}
# Getting Dataframes of All Data
  data_umap_plot <- data.frame(x = data_umap_all$layout[,1],
                   y = data_umap_all$layout[,2],
                   cell_type = region_dat$Cell_Type,
                   cell_group = region_dat$Cell_Group,
                   animal_label = region_dat$Animal,
                   concentration = region_dat$Fe,
                   panel_by = region_dat$Region)
  
  # Writing Labels
  var_label(data_umap_plot) <- list(cell_group = "Cell Group",
                                 cell_type = "Cell Type")

plot_test <- list()
plot_test_arrange <- list()

for (cell_groups in unique(data_umap_plot$cell_group)){
data_group <- data_umap_plot %>%
  filter(cell_group == cell_groups)
  
  for (animal in unique(data_umap_plot$animal_label)){
    data_filtered <- data_group %>%
      filter(animal_label %in% animal)
  
  plot <- 
    ggplot(data_filtered, aes(x, y, colour = concentration)) +
        geom_point(alpha=0.6, size=0.5) +
        theme_bw() + 
        xlim(min(data_umap_plot$x), quantile(data_umap_plot$x, 0.999)) + 
        ylim(min(data_umap_plot$y), quantile(data_umap_plot$y, 0.999)) +
        scale_colour_gradient(low = "red", high = "blue") +
        # guides(colour = guide_legend(override.aes = list(size=2),
        #                 nrow = ceiling(length(unique(data_umap_plot$cell_type))/9))) + 
        # guides(shape = guide_legend(override.aes = list(size = 2))) +
        # theme(legend.title = element_text(size = 5), 
        #       legend.text  = element_text(size = 5),
        #       legend.key.size = unit(0.1, "lines"))
        theme(legend.position='bottom') +
        easy_labs() +
  scale_colour_gradientn(name = "Concentration",
   colours = c("red", "orange", "yellow", "green", "blue", "purple", "violet"),
    values = rescale(c(0, 0.001, 0.01, 0.025, 0.05, 0.1, 1, 2, 3)),
    breaks = c(0, 0.001, 0.01, 0.05, 0.025, 0.1, 1, 2, 3))+
    # labels = as.character(c(0, 0.001, 0.01, 0.025, 0.05, 0.1, 1, 2, 3))) +
 guides(colour = guide_colourbar(
    title.position = "top",
    title.hjust = 0.5,
    label.position = "bottom",
    barwidth = unit(7, "cm"),
    barheight = unit(0.5, "cm"))) +
    ggtitle(paste0("Animal ", animal, " - ", cell_groups)) + 
    theme(legend.position = "none")
  
  plot_test[[cell_groups]][[animal]] <- plot_grid(plot, legend_grob, 
          ncol = 1, rel_heights = c(1, 0.2))
  
  plot_test_arrange[[cell_groups]][[animal]]  <- plot
  }

 four_plots <- plot_grid(plot_test_arrange[[cell_groups]]$B,
                         plot_test_arrange[[cell_groups]]$F,
                         plot_test_arrange[[cell_groups]]$H,
                         plot_test_arrange[[cell_groups]]$J,
                                               ncol = 2)
 plot_test_arrange[[cell_groups]] <- plot_grid(four_plots, legend_grid,
          ncol = 1, rel_heights = c(1, 0.2))
}

# plot_test_arrange$Crypt
# plot_test[["Crypt"]]$B

for (group in names(plot_test)){
  png(file.path(image_path, paste0("UMAP_Plot_Panels","_", group,"_", date, ".png")),
        height=16, width=14, units="in", res=500)
    
    print(plot_test_arrange[[group]])

    dev.off()}
    
for (animal in names(plot_test[["Crypt"]])){
  # Creating Images
    png(file.path(
      image_path, paste0("UMAP_Plot_Animal","_", animal, "_", "Crypt","_", date, ".png")),
       width=10, height=8, units="in", res=500)
    
    print(plot_test[["Crypt"]][[animal]])

    dev.off()
    
    # Creating Images
    png(file.path(
      image_path, paste0("UMAP_Plot_Animal","_", animal, "_", "Interspersed","_", date, ".png")),
        width=10, height=8, units="in", res=500)
    
    print(plot_test[["Interspersed"]][[animal]])

    dev.off()
}
```

